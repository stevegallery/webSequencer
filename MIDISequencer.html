
<!DOCTYPE html>
<html>

<head>
	<title>MIDI Sequencer</title>
	<style>
		#playButton {
			margin-bottom: 10px;
		}
	</style>
</head>

<body>

  <fieldset>
    <legend><b>Main</b></legend>
	<label for="tempoInput">Tempo (BPM):</label>
	<input type="number" id="tempoInput" min="1" value="240" onchange="updateOpts()"><br>
	<label for="notesInput">Number of Notes:</label>
	<input type="number" id="notesInput" min="1" value="8" onchange="updateOpts()"><br>
	<br>

	<label for="doubleNotesSelect">Double notes:</label>
	<select id="doubleNotesSelect" onchange="updateOpts()">
    <option value="0">none</option>
    <option value="1">same volume</option>
    <option value="2">half volume</option>
  </select>
	<br>
	<br>
	<label for="keySelect">Key:</label>
	<select id="keySelect" onchange="updateOpts()">
    <option value="C">C</option>
    <option value="C#">C#</option>
    <option value="D">D</option>
    <option value="D#">D#</option>
    <option value="E">E</option>
    <option value="F">F</option>
    <option value="F#">F#</option>
    <option value="G">G</option>
    <option value="G#">G#</option>
    <option value="A">A</option>
    <option value="A#">A#</option>
    <option value="B">B</option>
  </select>
	<br>
	<br>
	<label for="octaveLSelect">Octave range:</label>
	<select id="octaveLSelect" onchange="updateOpts()">
    <option value="0">0</option>
    <option value="1">1</option>
    <option selected value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
	<label for="octaveHSelect">through</label>
	<select id="octaveHSelect" onchange="updateOpts()">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option selected value="5">5</option>
  </select>
	<br>
<br>
	<label for="instrumentSelect">Main instrument:</label>
	<select id="instrumentSelect" onchange="updateOpts()"></select><br>
  				<br>
				<label for="volumeInput">Main volume:</label>
				<input type="range" id="volumeInput" min="1" max="127" value="63" onchange="updateOpts()"><br>
  </fieldset>
	<br>
<fieldset>
<legend><b>Added notes</b></legend>
	<font color=##FF0000><label for="harmonySelect">Relative note:</label>
		<select id="harmonySelect" onchange="updateOpts()">
    <option value="0">None</option>
    <option value="1">+1</option>
    <option value="2">+2</option>
    <option value="3">+3</option>
    <option value="4">+4</option>
    <option value="5">+5</option>
    <option value="6">+6</option>
    <option value="7">+7 (octave)</option>
    <option value="-1">-1</option>
    <option value="-2">-2</option>
    <option value="-3">-3</option>
    <option value="-4">-4</option>
    <option value="-5">-5</option>
    <option value="-6">-6</option>
    <option value="-7">-7 (octave)</option>
  </select>
		<label for="HinstrumentSelect">Instrument:</label>
		<select id="HinstrumentSelect" onchange="updateOpts()"></select>
		<br></font>


		<font color=#0000FF><label for="droneSelect">Static note:</label>
			<select id="droneSelect" onchange="updateOpts()">
      <option value="-1">None</option>
      <option value="0">root</option>
      <option value="5">minor</option>
    </select>

			<label for="DinstrumentSelect">Instrument:</label>
			<select id="DinstrumentSelect" onchange="updateOpts()">
    </select>

			<label for="droneTypeSelect">Note type:</label>
			<select id="droneTypeSelect" onchange="updateOpts()">
      <option selected value="0">individual notes</option>
      <option value="1">constant drone</option>
    </select>
			<br>
    </font>

			<font color=#A52A2A>
				<label for="bassSelect">Bass:</label>
				<select id="bassSelect" onchange="updateOpts()">
      <option value="0">None</option>
      <option value="6">minor</option>
      <option value="1">major</option>
    </select>

				<label for="BinstrumentSelect">Instrument:</label>
				<select id="BinstrumentSelect" onchange="updateOpts()">
    </select>
		</font>
    <br>
    				<label for="accSelect">Auto-accompaniment:</label>
				<select id="accSelect" onchange="updateOpts()">
              <option value="-1">None</option>
              <option value="0">same note as what human plays</option>
              <option value="99">root note (unchanging)</option>
              <option value="5">relative minor note (unchanging)</option>
              <option value="12">+1 octave</option>
              <option value="-12">-1 octave</option>
          </select>
				<label for="accInstrumentSelect">Instrument:</label>
				<select id="accInstrumentSelect" onchange="updateOpts()">
        </select>
				<label for="AvolumeInput">Volume:</label>
				<input type="range" id="AvolumeInput" min="1" max="127" value="63" onchange="updateOpts()">
</fieldset>
<br>
<fieldset>
  <legend><b>Drums</b></legend>
				<label for="drum1Select">Drum 1:</label>
				<select id="drum1Select" onchange="updateOpts()"></select>
				<label for="drum1beat">beat:</label>
				<select id="drum1beat" onchange="updateOpts()">
    <option value="0">None</option>
    <option value="99">Random</option>
    <option value="1">every beat</option>
    <option value="2">even beats</option>
    <option value="3">odd beats</option>
    <option selected value="4">every 4th beat</option>
    <option value="half">halfway through</option>
    <option value="end">at the end of the sequence</option>
  </select><br>

				<label for="drum2Select">Drum 2:</label>
				<select id="drum2Select" onchange="updateOpts()"></select>
				<label for="drum2beat">beat:</label>
				<select id="drum2beat" onchange="updateOpts()">
    <option value="0">None</option>
    <option value="99">Random</option>
    <option value="1">every beat</option>
    <option selected value="2">even beats</option>
    <option value="3">odd beats</option>
    <option value="4">every 4th beat</option>
        <option value="half">halfway through</option>
    <option value="end">at the end of the sequence</option>
  </select><br>


				<label for="drum3Select">Drum 3:</label>
				<select id="drum3Select" onchange="updateOpts()"></select>
				<label for="drum3beat">beat:</label>
				<select id="drum3beat" onchange="updateOpts()">
    <option value="0">None</option>
    <option value="99">Random</option>
    <option selected value="1">every beat</option>
    <option value="2">even beats</option>
    <option value="3">odd beats</option>
    <option value="4">every 4th beat</option>
        <option value="half">halfway through</option>
    <option value="end">at the end of the sequence</option>
  </select><br>

				<label for="drum4Select">Drum 4:</label>
				<select id="drum4Select" onchange="updateOpts()"></select>
				<label for="drum4beat">beat:</label>
				<select id="drum4beat" onchange="updateOpts()">
    <option value="0">None</option>
    <option value="99">Random</option>
    <option value="1">every beat</option>
    <option value="2">even beats</option>
    <option value="3">odd beats</option>
    <option value="4">every 4th beat</option>
        <option value="half">halfway through</option>
    <option value="end">at the end of the sequence</option>
  </select>
</fieldset>
<br>



        <fieldset>
          <legend><b>Effects</b></legend>
				<label for="reverb">Reverb send level:</label>
				<input type="range" id="reverb" min="0" max="127" step="1" value="64" onchange="updateOpts()">
				<br>
				<label for="chorus">Chorus Depth:</label>
				<input type="range" id="chorus" min="0" max="127" step="1" value="64"  onchange="updateOpts()">
				</fieldset>
        <br>
				<fieldset>
        <legend><b>Sequence</b></legend>
				<button id="playButton" onclick="playNotes()">Play</button>
				<button id="stopButton" onclick="stop()">Stop</button>
        <h2 id="noteDisplay"></h2>
        </fieldset>
        <br>
				<fieldset>
        <legend><b>Loop</b></legend>        
<button id="startRecordingButton" onclick="startRecording()">Record what I play</button>
<button id="playbackButton"onclick="playback()">Play back what I recorded</button>
<button id="stopPlaybackButton"onclick="stopPlayback()">Stop playback</button>
				
        <label for="UInstrumentSelect">Instrument:</label>
				<select id="UInstrumentSelect" onchange="updateOpts()">
        </select>
				<label for="UvolumeInput">Volume:</label>
				<input type="range" id="UvolumeInput" min="1" max="127" value="63" onchange="updateOpts()">

				<h3 id="liveDisplay"></h3>
        </fieldset>
				<hr>
				<div id="status"></div>

				<script>
					// options
    let scale = []; // Updated based on the selected key
    tempo =0;
    noteDuration = 0;
    instrumentValue = 0;
    HinstrumentValue = 0;
    DinstrumentValue = 0;
    BinstrumentValue = 0;
    accInstrumentValue = 0;
    UInstrumentValue = 0;
    numNotes = 0;
    harmonyValue =0;
    droneValue =0;
    droneType =0;
    bassValue =0;
    accValue =0;
    octaveLValue =0;
    octaveHValue =0;
    volume=0;
    Avolume=0;
    Uvolume=0;

    chorusFilterValue=0;
    reverbFilterValue=0;
       
    let drumBeat  = []; 
    let drumValue  = []; 
    const numDrums =4;

    let seq = []; 
    let seqOct = []; 

    let stopped=false;
    let doubleNotes=0;

    var midiInput;
    var midiOutput;

    let recording = false;
    let recordWaiting = false;
    let playingBack= false;
    let recordedMidiEvents = [];
    let recordStartTime;

  let midiMessages = [];  // store all midis here, for saving


// functions for buttons for recording and playing back user keyboard
function startRecording() {
  recording = false;
  playingBack= false;
  recordWaiting = true;
  document.getElementById('startRecordingButton').innerText="Waiting for user notes...";
  document.getElementById('startRecordingButton').style.backgroundColor = "LightPink";

}

function playback() {
  recording = false;
  recordWaiting = false;
  document.getElementById('startRecordingButton').innerText="Record what I play";
  document.getElementById('startRecordingButton').style.backgroundColor = "";
  playingBack= true;
  document.getElementById('playbackButton').innerText="Playing recorded user notes...";
  document.getElementById('playbackButton').style.backgroundColor = "LightBlue";
  liveDisplay.innerHTML = "I played back note: "
}
function stopPlayback() {
  playingBack= false;
  document.getElementById('playbackButton').innerText="Play back what I recorded";
  document.getElementById('playbackButton').style.backgroundColor = "";
}


    // Get a random note from the scale
    function getRandomNote() {
      const randomIndex = Math.floor(Math.random() * scale.length);
      return randomIndex;
    }



    function getRandomOctave() {
      const randomOct = Math.floor(Math.random() * (octaveHValue-octaveLValue+1)) + parseInt(octaveLValue);
      return randomOct;
    }

    // Get the harmony note for a given interval
    function getHarmonyNote(noteInScale, interval) {
	    let h=Number(noteInScale) + Number(interval);
	    if (h>=scale.length) {
        h -= scale.length;
      }
      if (h<0) {
        h += scale.length;
      }
      return scale[h];	  
    }

    // Get the drone note in current key
    function getDroneNote(noteInScale) {
	    let h=Number(noteInScale);
      return scale[h];	  
    }

    // Get random bass note 
    function getBassNote() {
      let bassNotes = [];

        switch (bassValue) {
        case '1':
         bassNotes = [ scale[0], scale[0],  scale[2], scale[3], scale[4]];
          break;
        case '6':
	        bassNotes = [ scale[5], scale[5],  scale[5], scale[4], scale[4]];
          break;
      }


      const randomIndex = Math.floor(Math.random() * bassNotes.length);
      return bassNotes[randomIndex];	  
    }

    // Populate instrument options with instrument names
    function populateInstrumentOptions() {
      const instrumentSelect = document.getElementById('instrumentSelect');
      const HinstrumentSelect = document.getElementById('HinstrumentSelect');
      const DinstrumentSelect = document.getElementById('DinstrumentSelect');
      const BinstrumentSelect = document.getElementById('BinstrumentSelect');
      const accInstrumentSelect = document.getElementById('accInstrumentSelect');
      const UInstrumentSelect = document.getElementById('UInstrumentSelect');

      // General MIDI (GM) instrument names
      const instrumentNames = [
        'Acoustic Grand Piano', 'Bright Acoustic Piano', 'Electric Grand Piano', 'Honky-tonk Piano',
        'Electric Piano 1', 'Electric Piano 2', 'Harpsichord', 'Clavi',
        'Celesta', 'Glockenspiel', 'Music Box', 'Vibraphone',
        '*Marimba', 'Xylophone', 'Tubular Bells', 'Dulcimer',
        '*Drawbar Organ', '*Percussive Organ', 'Rock Organ', 'Church Organ',
        'Reed Organ', 'Accordion', 'Harmonica', 'Tango Accordion',
        'Acoustic Guitar (nylon)', 'Acoustic Guitar (steel)', 'Electric Guitar (jazz)', 'Electric Guitar (clean)',
        '*Electric Guitar (muted)', 'Overdriven Guitar', 'Distortion Guitar', 'Guitar Harmonics',
        'b-Acoustic Bass', 'Electric Bass (finger)', 'b-Electric Bass (pick)', 'b-Fretless Bass',
        'Slap Bass 1', 'Slap Bass 2', 'Synth Bass 1', 'b-Synth Bass 2',
        'Violin', 'Viola', 'Cello', 'Contrabass',
        'Tremolo Strings', '*Pizzicato Strings', 'Orchestral Harp', 'Timpani',
        '*String Ensemble 1', '*String Ensemble 2', '*Synth Strings 1', '*Synth Strings 2',
        'Choir Aahs', 'Voice Oohs', '*Synth Choir', 'Orchestra Hit',
        'Trumpet', 'Trombone', 'Tuba', 'Muted Trumpet',
        'French Horn', 'Brass Section', 'Synth Brass 1', 'Synth Brass 2',
        'Soprano Sax', 'Alto Sax', 'Tenor Sax', 'Baritone Sax',
        'Oboe', 'English Horn', 'Bassoon', 'Clarinet',
        'Piccolo', '*Flute', 'Recorder', 'Pan Flute',
        'Blown Bottle', 'Shakuhachi', 'Whistle', '*Ocarina',
        '*Lead 1 (square)', 'Lead 2 (sawtooth)', 'Lead 3 (calliope)', 'Lead 4 (chiff)',
        'Lead 5 (charang)', 'Lead 6 (voice)', 'Lead 7 (fifths)', '*Lead 8 (bass + lead)',
        '*Pad 1 (new age)', '*Pad 2 (warm)', 'Pad 3 (polysynth)', 'Pad 4 (choir)',
        'Pad 5 (bowed)', '*Pad 6 (metallic)', '*Pad 7 (halo)', 'Pad 8 (sweep)',
        '*FX 1 (rain)', '*FX 2 (soundtrack)', '*FX 3 (crystal)', '*FX 4 (atmosphere)',
        '*FX 5 (brightness)', 'FX 6 (goblins)', '*FX 7 (echoes)', '*FX 8 (sci-fi)',
        'Sitar', 'Banjo', 'Shamisen', 'Koto',
        'Kalimba', 'Bag pipe', 'Fiddle', 'Shanai',
        'Tinkle Bell', 'Agogo', 'Steel Drums', 'Woodblock',
        'Taiko Drum', 'Melodic Tom', 'Synth Drum', 'Reverse Cymbal',
        'Guitar Fret Noise', 'Breath Noise', 'Seashore', 'Bird Tweet',
        'Telephone Ring', 'Helicopter', 'Applause', 'Gunshot'
      ];
         const drumNames = [   
'x Chinese Bass Drum',
'x Peking cymbals',
'x Filter Snap',
'x Slap Noise',
'x Scratch Push',
'x Scratch Pull',
'x Drumsticks',
'x Click noise',
'Metronome Click',
'Metronome Bell',
'*Acoustic Bass Drum',
'*Electric Bass Drum',
'Side Stick',
'*Acoustic Snare',
'*Hand Clap',
'*Electric Snare',
'*Low Floor Tom',
'*Closed Hi-hat',
'High Floor Tom',
'Pedal Hi-hat',
'Low Tom',
'Open Hi-hat',
'Low-Mid Tom',
'High-Mid Tom',
'Crash Cymbal 1',
'High Tom',
'Ride Cymbal 1',
'Chinese Cymbal',
'Ride Bell',
'*Tambourine',
'*Splash Cymbal',
'Cowbell',
'Crash Cymbal 2',
'Vibraslap',
'Ride Cymbal 2',
'High Bongo',
'Low Bongo',
'Mute High Conga',
'Open High Conga',
'Low Conga',
'High Timbale',
'Low Timbale',
'High Agogô',
'Low Agogô',
'*Cabasa',
'*Maracas',
'Short Whistle',
'Long Whistle',
'Short Guiro',
'Long Guiro',
'Claves',
'High Woodblock',
'Low Woodblock',
'Mute Cuica',
'Open Cuica',
'Mute Triangle',
'Open Triangle',
'*Shaker',
'x Jingle bell',
'x Bellchime',
'x Castanets',
'x Muted Surdo',
'x Open Surdo',
'x Tam-Tam 1',
'x Tam-Tam 2'
];
      // MIDI instruments dropdown
      for (let i = 0; i < instrumentNames.length; i++) {
        // main instrument
        const option = document.createElement('option');
        option.value = i;
        if (i == 87) {
          option.selected = true;
        }
        option.text = `${instrumentNames[i]}`;
        instrumentSelect.appendChild(option);

        // harmony instrumnt
        const Hoption = document.createElement('option');
        Hoption.value = i;
        if (i == 87) { // set default
          Hoption.selected = true;
        }
        Hoption.text = `${instrumentNames[i]}`;
        HinstrumentSelect.appendChild(Hoption);
        
        // drone instrumnt
        const Doption = document.createElement('option');
        Doption.value = i;
        if (i == 87) { // set default
          Doption.selected = true;
        }
        Doption.text = `${instrumentNames[i]}`;
        DinstrumentSelect.appendChild(Doption);
        
        // bass instrumnt
        const Boption = document.createElement('option');
        Boption.value = i;
        if (i == 39) { // set default
          Boption.selected = true;
        }
        Boption.text = `${instrumentNames[i]}`;
        BinstrumentSelect.appendChild(Boption);

        // auto-accompany instument
        const Aoption = document.createElement('option');
        Aoption.value = i;
        if (i == 48) {
          Aoption.selected = true;
        }
        Aoption.text = `${instrumentNames[i]}`;
        accInstrumentSelect.appendChild(Aoption);

        // user-notes-playback instument
        const Uoption = document.createElement('option');
        Uoption.value = i;
        if (i == 48) {
          Uoption.selected = true;
        }
        Uoption.text = `${instrumentNames[i]}`;
        UInstrumentSelect.appendChild(Uoption);

      }
      
      // MIDI drum dropdorwns
      for (let d = 0; d < drumNames.length; d++) {

        // drum 1
        const option1 = document.createElement('option');
        option1.value = d;
        if (d == 13) {
          option1.selected = true;
        }
        option1.text = `${drumNames[d]}`;        
        drum1Select.appendChild(option1);

        // drum 2
        const option2 = document.createElement('option');
        option2.value = d;
        if (d == 16) {
          option2.selected = true;
        }
        option2.text = `${drumNames[d]}`;        
        drum2Select.appendChild(option2);

      // drum 3
        const option3 = document.createElement('option');
        option3.value = d;
        if (d == 17) {
          option3.selected = true;
        }
        option3.text = `${drumNames[d]}`;        
        drum3Select.appendChild(option3);

        // drum 4
        const option4 = document.createElement('option');
        option4.value = d;
        if (d == 30) {
          option4.selected = true;
        }
        option4.text = `${drumNames[d]}`;        
        drum4Select.appendChild(option4);

      }


    }


     


    function updateOpts() {

      // filers / effects
      chorusFilterValue = parseInt(document.getElementById('chorus').value, 10);
      reverbFilterValue = parseInt(document.getElementById('reverb').value, 10);



      const keySelect = document.getElementById('keySelect');
      const selectedKey = keySelect.value;

      // Update the scale based on the selected key
      switch (selectedKey) {
        case 'C':
          scale = [60, 62, 64, 65, 67, 69, 71];
          break;
        case 'C#':
          scale = [61, 63, 65, 66, 68, 70, 72];
          break;
        case 'D':
          scale = [62, 64, 66, 67, 69, 71, 73];
          break;
        case 'D#':
          scale = [63, 65, 67, 68, 70, 72, 74];
          break;
        case 'E':
          scale = [64, 66, 68, 69, 71, 73, 75];
          break;
        case 'F':
          scale = [65, 67, 69, 70, 72, 74, 76];
          break;
        case 'F#':
          scale = [66, 68, 70, 71, 73, 75, 77];
          break;
        case 'G':
          scale = [67, 69, 71, 72, 74, 76, 78];
          break;
        case 'G#':
          scale = [68, 70, 72, 73, 75, 77, 79];
          break;
        case 'A':
          scale = [69, 71, 73, 74, 76, 78, 80];
          break;
        case 'A#':
          scale = [70, 72, 74, 75, 77, 79, 81];
          break;
        case 'B':
          scale = [71, 73, 75, 76, 78, 80, 82];
          break;
        default:
          scale = []; // Set an empty scale if an invalid key is selected
      }


      const tempoInput = document.getElementById('tempoInput');
       tempo = parseInt(tempoInput.value);
       noteDuration = (60 / tempo) * 1000; // Duration of each note in milliseconds


      const doubleNotesSelect = document.getElementById('doubleNotesSelect');
      doubleNotes = parseInt(doubleNotesSelect.value);

      // get midi voice selections
      const instrumentSelect = document.getElementById('instrumentSelect');
      instrumentValue = parseInt(instrumentSelect.value);

      const HinstrumentSelect = document.getElementById('HinstrumentSelect');
      HinstrumentValue = parseInt(HinstrumentSelect.value);

      const DinstrumentSelect = document.getElementById('DinstrumentSelect');
      DinstrumentValue = parseInt(DinstrumentSelect.value);

      const BinstrumentSelect = document.getElementById('BinstrumentSelect');
      BinstrumentValue = parseInt(BinstrumentSelect.value);

      const accInstrumentSelect = document.getElementById('accInstrumentSelect');
      accInstrumentValue = parseInt(accInstrumentSelect.value);

      const UInstrumentSelect = document.getElementById('UInstrumentSelect');
      UInstrumentValue = parseInt(UInstrumentSelect.value);


      const notesInput = document.getElementById('notesInput');
      numNotes = parseInt(notesInput.value);

      const harmonySelect = document.getElementById('harmonySelect');
      harmonyValue = harmonySelect.value;

      const accSelect = document.getElementById('accSelect');
      accValue = accSelect.value;

      const droneSelect = document.getElementById('droneSelect');
      droneValue = droneSelect.value;

      const droneTypeSelect = document.getElementById('droneTypeSelect');
      droneType = droneTypeSelect.value;


      const bassSelect = document.getElementById('bassSelect');
      bassValue = bassSelect.value;

      const octaveLSelect = document.getElementById('octaveLSelect');
      octaveLValue = octaveLSelect.value;

      const octaveHSelect = document.getElementById('octaveHSelect');
      octaveHValue = octaveHSelect.value;

      // fix out of order octave selection
      if ( octaveHValue < octaveLValue) {
        octaveHValue = octaveLValue;
        octaveHSelect.value = octaveHValue;
      }

      // get drum selctions
      drum1Select = document.getElementById('drum1Select');
      drumValue[0] = parseInt(drum1Select.value);
      
      drum2Select = document.getElementById('drum2Select');
      drumValue[1] = parseInt(drum2Select.value);

      drum3Select = document.getElementById('drum3Select');
      drumValue[2] = parseInt(drum3Select.value);

      drum4Select = document.getElementById('drum4Select');
      drumValue[3] = parseInt(drum4Select.value);
    
      drumBeat[0]= document.getElementById('drum1beat').value;
      drumBeat[1]= document.getElementById('drum2beat').value;
      drumBeat[2]=document.getElementById('drum3beat').value;
      drumBeat[3]=document.getElementById('drum4beat').value;
    
      for (let d=0; d< numDrums; d++ ) {
        if (drumBeat[d] == "half") {
          drumBeat[d] = Math.floor (numNotes/2);
        }

        if (drumBeat[d] == "end") {
          drumBeat[d] = numNotes;
        }
    }



      const volumeInput = document.getElementById('volumeInput');
      volume = parseInt(volumeInput.value);

      const AvolumeInput = document.getElementById('AvolumeInput');
      Avolume = parseInt(AvolumeInput.value);
  
      const UvolumeInput = document.getElementById('UvolumeInput');
      Uvolume = parseInt(UvolumeInput.value);

    }

    function stop() {
      stopped = true;
    }

    // play back the notes that user played/recorded, on its own channel
    function playRecordedMidi() {

    
      sendStoreMIDI([0xC5, UInstrumentValue]); // Set instrument
          
      recordedMidiEvents.forEach(event => {
          setTimeout(() => {
              //sendStoreMIDI(event.data);
              // Note on?
              if (event.data[0] >= 0x90 && event.data[0] <= 0x9F && event.data[2] > 0) {   
                liveDisplay.innerHTML += getNoteName(event.data[1]) + " ";              
                sendStoreMIDI([0x95, event.data[1], Uvolume]); // put note on
              } else if ((event.data[0] >= 0x80 && event.data[0] <= 0x8F) || (event.data[0] >= 0x90 && event.data[0] <= 0x9F && event.data[2] == 0)) { // if note off
                sendStoreMIDI([0x85, event.data[1], 0x00]); // note off
              }
          }, event.timestamp);
      });
}




    // Play the randomly generated notes 
    function playNotes() {
      stopped=false;
      updateOpts();

   
     const status= document.getElementById('status');
      noteDisplay.innerHTML = "";


// generate sequence of notes
    let seq = []; 
    let seqOct = []; 
    let noteSkip=1;
    if (doubleNotes >0) {
      noteSkip=2;
    }
    for (let s=0;s < numNotes; s+=noteSkip) {
        seq[s]= getRandomNote();
        seqOct[s]= getRandomOctave();        
        if (doubleNotes >0) {
          seq[s+1]=seq[s]
          seqOct[s+1]=seqOct[s];
        }
    }
    
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess()
          .then(function (midiAccess) {
            midiOutput = midiAccess.outputs.values().next().value;

            if (!midiOutput) {
              status.innerHTML = "No MIDI device was found";
            } else {
              status.innerHTML = "Successfully connected to midi device '"+midiOutput
              .name+"'";

            midiInput = midiAccess.inputs.values().next().value;
            if (!midiInput) {
              status.innerHTML = "No MIDI input device found";
            } else {  
              midiInput.onmidimessage = onMidiMessage;
            }

              // play all instruments and drums
              playSequence(0);

              function playSequence(current) {
                if (current == 0) {
                  // set base start time for recording, it's awlays rest to start of most recevtn loop
                  recordStartTime = Date.now();

                  if (playingBack) {                
                    liveDisplay.innerHTML = "I played back note: ";
                    playRecordedMidi(); // kick off all the notes previously recorded
                  }

                }

                if ( (current < seq.length) && (!stopped)) {

                  // set effect filter values              
                  sendStoreMIDI([0xB0, 91, reverbFilterValue]);  // CC message
                  sendStoreMIDI([0xB0, 93, chorusFilterValue]);  // CC message                



                  // Set the main instrument
                  sendStoreMIDI([0xC0, instrumentValue]);
            
                  ////// main note
                  const noteInScale= seq[current];
                  const oct =seqOct[current];
                  note=scale[noteInScale];
                  
                  // move note to ocatve              
                  note = note + (oct -4) * 12;

		              const noteName = getNoteName(note);
		              noteDisplay.innerHTML += noteName;

                  ////// relative/harmony note
                  harmonyNote = getHarmonyNote(noteInScale, harmonyValue);   
                  hOct =1;
                  if (harmonyValue <0) {
                    hOct =-1;
                  }
                  // move harmony note to ocatve              
                  harmonyNote  = harmonyNote + (oct-4+hOct) * 12;             
                  const harmonyNoteName = getNoteName(harmonyNote);

		              if (harmonyValue != 0) {
                    noteDisplay.innerHTML +='/<font color=##FF0000>' + harmonyNoteName + '</font>';
		              } 
                
                  ////// static/drone note
                  droneNote = getDroneNote(droneValue);   
                  hOct =1;
                  if (droneValue <0) {
                    hOct =-1;
                  }
                  // move drone note to ocatve              
                  droneNote  = droneNote + (oct-4+hOct) * 12;             
                  const droneNoteName = getNoteName(droneNote);

		              if (droneValue >= 0) {
                    noteDisplay.innerHTML +='/<font color=#0000FF>' + droneNoteName + '</font>';
		              } 
                
                  ////// bass note
                  bassNote = getBassNote();   
                  // move bass note to ocatve              
                  bassNote  = bassNote + (-2 * 12);    
                  const bassNoteName = getNoteName(bassNote);
                  if (bassValue != 0) {
                    noteDisplay.innerHTML +='/<font color=#A52A2A>' + bassNoteName + '</font>';
		              }                 


		              noteDisplay.innerHTML +=' ';

                  if ( (doubleNotes==2) && (current%2==1)) {
                      sendStoreMIDI([0x90, note, volume/2]); // main Note 1/2                      
                  } else {
                      sendStoreMIDI([0x90, note, volume]); // main Note on
                  }

                  if (harmonyValue != 0) {
                    sendStoreMIDI([0xC1, HinstrumentValue]); // Set instrument
                    sendStoreMIDI([0x91, harmonyNote, volume]); // Harmony note on
                  }

                  if (droneValue >= 0) {
                    sendStoreMIDI([0xC2, DinstrumentValue]); // Set instrument
                    sendStoreMIDI([0x92, droneNote, volume]); // drone note on
                  }

                  if (bassValue != 0) {                    
                    sendStoreMIDI([0xC3, BinstrumentValue]); // Set bass instrument
                    sendStoreMIDI([0x93, bassNote, volume]); // bass note on
                  }

                  ////// drum notes
                  for (let d=0; d<numDrums; d++) {
                    drumRem =0;      
                    drumPlay = drumBeat[d];              

                    if (drumBeat[d] == 3) { // adjust for "odd beat" choice
                      drumRem =1;
                      drumPlay=2;
                    }                  

                    // Set drum
                    if (drumBeat[d] ==99) { // random drum
                      const randomBeat = Math.floor(Math.random() * seq.length/4);
                      if (randomBeat ==1 ) {
                        sendStoreMIDI([0x99, drumValue[d]+25, volume]); // drum on
                      }
                    } else {
                      if (drumBeat[d]>0 && (current%drumPlay==drumRem)) {
                        sendStoreMIDI([0x99, drumValue[d]+25, volume]); // drum on
                      }
                    }


                  }
                  setTimeout(function () {
                    sendStoreMIDI([0x80, note, 0x00]); // main Note off
		                if (harmonyValue!=0) {
                      sendStoreMIDI([0x81, harmonyNote, 0x00]); // Harmony note off
                    }   
                    if (droneValue >=0) {
                      if (droneType == 0) {
                        sendStoreMIDI([0x82, droneNote, 0x00]); // drone note off
                      }
                    }              
                    if (bassValue!=0) {
                      sendStoreMIDI([0x83, bassNote, 0x00]); // bass note off
                    }   
                  

                  for (let d=0; d<numDrums; d++) {
                    if (drumBeat[d]>0) {
                      sendStoreMIDI([0x89, drumValue[d]+25, 0x00]); // drum off
                    }
                  }

                    playSequence(current + 1);
                  }, noteDuration);
                } else {
                  //status.innerHTML = "Done playing sequence.";
                  // ok done a sequence, stop recording if i was
                  if (recording) {
                    recording = false;
                    playback();  // switch to playing back
                  }
                  if (!stopped) {
                    //status.innerHTML += " Restarting sequence.";
                    noteDisplay.innerHTML =' ';
                    liveDisplay.innerHTML =' ';
                    playSequence(0);
                  }
                }
              }
            }
          })
          .catch(function (error) {
            status.innerHTML = 'Error: ' + error;
          });
      } else {
       status.innerHTML = 'Web MIDI API is not supported in this browser';
      }
    }

    // Populate the instrument options on page load
    window.addEventListener('load', populateInstrumentOptions);

    // Get the name of a MIDI note
    function getNoteName(note) {
      const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const octave = Math.floor(note / 12) - 1;
      const noteName = noteNames[note % 12];
      return noteName + octave;
    }




function onMidiMessage(event) { // when note is played on attached synth
    
    const notePlayed = event.data[1];
    
    if (recordWaiting) {
      // a note was played, start recording
      recordWaiting = false;
      recording=true;

      recordedMidiEvents = [];

      document.getElementById('startRecordingButton').innerText="Recording user notes...";
      document.getElementById('startRecordingButton').style.backgroundColor = "LightPink";
      liveDisplay.innerHTML = "I recorded:";
    }

    if (recording) {
      // save the note       
      let currentTime = Date.now();
      let timeFromStart = currentTime - recordStartTime;

      recordedMidiEvents.push({ data: event.data, timestamp: timeFromStart });
      // Note on?
      if (event.data[0] >= 0x90 && event.data[0] <= 0x9F && event.data[2] > 0) {   
        liveDisplay.innerHTML += getNoteName(notePlayed) + " ";
      }
    }


    if (accValue != -1) { // play accompainment note
      accNote =Number(notePlayed) + Number(accValue);

      // special cases
      if (accValue==5) {
        accNote = getDroneNote(accValue);
      }         
      if (accValue==99) {
        accNote = getDroneNote(0);
      }

      // Note on?
      if (event.data[0] >= 0x90 && event.data[0] <= 0x9F && event.data[2] > 0) {     
          // play accompainment note on its channel
          sendStoreMIDI([0xC4, accInstrumentValue]); // Set accomp instrument
          sendStoreMIDI([0x94, accNote, Avolume]); // acc note on
          liveDisplay.innerHTML = "You played:" + getNoteName(notePlayed) + ", and I added:" +getNoteName(accNote);
      }
      // Note off OR Note on with velocity 0 (some keyboards use this as Note off)
      else if ((event.data[0] >= 0x80 && event.data[0] <= 0x8F) || (event.data[0] >= 0x90 && event.data[0] <= 0x9F && event.data[2] == 0)) {
              sendStoreMIDI([0x84, accNote, 0x00]); // acc note off
      }
    }
}


// Function to send MIDI messages and store them
function sendStoreMIDI( message) {
    midiOutput.send(message);
    midiMessages.push({ time: performance.now(), data: message });
}



// Function to save stored MIDI messages to a .mid file
function saveToFile() {

}




				</script>
</body>

</html>
